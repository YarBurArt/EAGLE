# EAGLE - Emulated Attack Generator w/ Layered Engine

Генератор атак с многоуровневым движком (Emulated Attack Generator with Layered Engine, eagle) - это интерактивная система для построения и выполнения реалистичных цепочек атак на основе стадий [Унифицированный килчейн](https://www.unifiedkillchain.com/) и поддерживает динамическое формирование цепочек атак в реальном времени. Работает в контексте API, использующего внутри GraphQL и библиотеку Mythic, с минимальным интерфейсом.

Платформа функционирует через инфраструктуру Mythic C2 + агенты, нулевой агент и поддерживает генерацию новых агентов во время атаки, эмулируя боковое перемещение и закрепление в инфраструктуре.

Команды, выполняемые локально, выполняются (как для первых стадий цепочки) через нулевой агент.

Проект разработан с использованием `FastAPI` + `PostgreSQL` (`SQLAlchemy 2.0` + `alembic`), основан на
[Minimal async FastAPI + PostgreSQL template](https://github.com/rafsaf/minimal-fastapi-postgres-template/tree/main) 

## Требования

На данный момент тестирование проводилось в основном на последних версиях `Kali Linux` и `Parrot OS`. Debian с версией ниже 13 может потребовать [сборки нового Python](https://docs.python.org/3/using/unix.html#building-python
) из исходников. Последние версии `Astra Linux` (Debian 10-12 с политикой МКЦ/МРД) имеют такую же проблему, но по какой-то причине скрипт install_docker_kali.sh работает для mythic, и даже считает контейнеры mythic и EAGLE безопасными. EAGLE также может работать, если mythic находится на удаленном хосте, нулевой агент - на другом, а PostgreSQL не находится в контейнере. В Windows проще всего запускать через `WSL2` на Ubuntu или Kali.

Основное требование - `python3.13` и выше.

Если вы решите не использовать Docker, следует применять `PostgreSQL 17`.

Минимальные требования к оперативной памяти - 4-8 ГБ, но рекомендуется 16 ГБ из-за агентов, профилей Mythic C2 и самого нулевого агента.
Минимум - двухъядерный процессор, хотя с контейнерами это может быть затруднительно.


## Установка
Сначала необходимо установить и запустить Mythic C2 https://docs.mythic-c2.net/installation

На данный момент нулевой агент также должен работать. По сути, вы заражаете себя в режиме отладки и подключаетесь к C2. Важный момент - первый `callback_display_id` для подключения к EAGLE, который вам нужно будет указать в интерфейсе. В Mythic C2 он находится слева от активного callback.

Клонируйте репозиторий
```bash
git clone https://github.com/eogod/EAGLE.git

```
```bash
cd ./EAGLE/backend
```

На этом этапе вам нужно задать значения `.env` в EAGLE/backend следующим образом, порт базы данных должен отличаться от postgres Mythic C2, переменные `MYTHIC__` должны быть взяты из вашего `Mythic/.env`
```env
SECURITY__JWT_SECRET_KEY=super_secret_key
SECURITY__BACKEND_CORS_ORIGINS=["http://127.0.0.1:3001","http://localhost:8001", "http://localhost:8000", "http://127.0.0.1:8000"]
SECURITY__ALLOWED_HOSTS=["localhost", "127.0.0.1"]

DATABASE__HOSTNAME=localhost
DATABASE__USERNAME=super_secret_user
DATABASE__PASSWORD=super_secret_password
DATABASE__PORT=5455
DATABASE__DB=default_db

MYTHIC__SERVER_IP=127.0.0.1
MYTHIC__USERNAME=super_secret_user
MYTHIC__PASSWORD=super_secret_password
MYTHIC__SERVER_PORT=7443
MYTHIC__TIMEOUT=-1
MYTHIC__PAYLOAD_PORT_HTTP=1337
```

Если вам нужен локальный LLM через [ollama](https://github.com/ollama/ollama), добавьте в `env` также следующее. Мы рекомендуем эти модели [Mistral](https://ollama.com/library/mistral), [Qwen3-ab](https://ollama.com/jaahas/qwen3-abliterated), [llama3.1:8b](https://ollama.com/library/llama3.1), [llama3.1-ab:8b](https://ollama.com/mannix/llama3.1-8b-abliterated) (более свободный), [Qwen2.5-coder:32b](https://ollama.com/library/qwen2.5-coder) в зависимости от ваших ресурсов.

```env
LLMSERVICE__LOCAL=1
LLMSERVICE__API_URL=http://localhost:69228
LLMSERVICE__API_KEY=super_secret_key
LLMSERVICE__TIMEOUT=120
LLMSERVICE__DEFAULT_MODEL=mistral
```
иначе значения будут взяты из [конфига](https://github.com/eogod/EAGLE/blob/main/backend/app/core/config.py), и вы можете увидеть валидацию и типы там.


Установка зависимостей
```bash
# Poetry установка зависимостей из .lock (python3.13)
poetry install
# или на debian / parrot
python3.13 -m poetry install
```
Если возникает ошибка (например как на Kali 2023-2024), то может помочь:
```bash
python3 -m venv env
source env/bin/activate
# затем та же самая установка, что и выше
```
Запуск базы данных и миграций по порядку
```bash
# если без докера - ищите в доках дистрибутива
docker-compose up -d

python3.13 -m poetry shell

# запуск Alembic для применения изменений в бдшке
alembic upgrade head
```
Запуск backend FastAPI
```bash
python3.13 -m poetry shell  # если выходили из нее

# это не безопасно, но без фронта временное решение
uvicorn app.main:app --reload  --host 0.0.0.0 --port 8000
```

## Использование

- Интерфейс: **/f/index**
- API с документацией: **http://127.0.0.1:8000**

### Основные API ручки
1. **Авторизация**:
- **/auth/register** - регистрация
- **/auth/access-token** - получение JWT токена

2. **Создание цепочки атак**:
- **/cmd/new-chain/** - создание новой цепочки
- **/cmd/run-command** - выполнение локальных (также консольных) команд с нуль-агентом
- **/cmd/run-agent-command** - выполнение специфических команд агентов
- **/cmd/reject-s/{chain_name}** - отклонение последней команды

3. **Управление агентами**:
- **/cmd/new-agent** - создание полезной нагрузки в Mythic
- **/cmd/approve-action** - исполнение через тип payload/callback
- **/cmd/update-agents** - сохранение новых агентов в бдшки

4. **Управление фазами атаки**:
- **/cmd/next-phase/{chain_id}** - переход к следующей фазе UCKC
- **/cmd/set-phase/{chain_id}** - установка конкретной фазы UCKC
- **/cmd/chain-phase/{chain_id}** - получение информации о цепочке

5. **Работа с LLM**:
- **/llm/suggest-action** - генерация команд конкретно EAGLE через нейронки
- **/cmd/approve-action** - исполнение/сохранение сгенерированных действий
- в выводе большинства команд есть анализ stdout от LLM
- etc payload ...

6. **Выполнение и управление цепочкой**:
- **/cmd/run-chain/{chain_id}** - запуск цепочки
- отмена запуска только через GUI  /f/index

7. **Экспорт**:
- **/export-chain/json** - экспорт цепочки в JSON
- **/export-chain/yaml** - экспорт цепочки в YAML


### /auth/ авторизация и аутентификация по JWT

По умолчанию приложение работает по адресу **http://127.0.0.1:8000** и подключается к `Mythic C2` при запуске. 
По этому URL вы найдете API с `Swagger UI`. Интерфейс находится по адресу **/f/index** на данный момент. 
Регистрация доступна через **/auth/register** с использованием электронной почты/пароля, это необходимо, так как AttackChains привязаны к пользователям по ID. После регистрации вы можете войти в систему и получить JWT токен через **/auth/access-token** (или через авторизацию Swagger).
> Обратите внимание, что полем для входа является электронная почта, которую вы использовали при регистрации.

### /cmd/ основные комманды, часть сразу сохраняются в цепочке

После аутентификации вы можете создать новую цепочку атак с помощью **/cmd/new-chain/**. 
Новая цепочка с указанным вами именем будет присвоен ID, который используется для привязки шагов к этой цепочке.
> Для упрощения имена утилит и их типы связаны, цепочка состоит из отдельных шагов, каждый из которых подключен к агентам и содержит информацию о текущей фазе атаки.

Первые команды часто связаны с разведкой и выполняются локально, поэтому вам нужен `нуль агент` и его `display_id`, 
который вы включаете в запросы к **/cmd/run-command**. 
Если вы могли сделать ошибку и какая-либо команда по какой-то причине была сохранена в БД, вы можете отклонить последнюю сохраненную команду в цепочке и удалить ее через **/cmd/reject-s/{chain_name}**.

Для команд, специфичных для агентов, используйте **/cmd/run-agent-command**, также указывая имя утилиты агента, например для локального использования оно установлено как `shell`. 
Команды, выполненные таким образом, сразу сохраняются в цепочке, вы можете использовать LLM для помощи в генерации команд и анализе вывода.
> Обратите внимание, что LLM не записывает данные напрямую в базу данных, и решения LLM принимаются пользователем.

Вы можете создавать полезные нагрузки через LLM и направлять их через proc **/cmd/approve-action** c типом payload / getcalback, затем запустите **/cmd/update-agents**, чтобы сохранить новые агенты в базе данных для воспроизводимости цепочки. Если задаче нужны более точные настройки или LLM делает ошибку где-то, вам следует использовать **/cmd/new-agent** для создания полезной нагрузки mythic через EAGLE в контексте цепочки, затем **/cmd/run-command** для загрузки полезной нагрузки на удаленный хост, а затем также **/cmd/update-agents**.


### /cmd/ управление стадией килчейна, цепочкой атаки 

Вы можете установить фазы атаки с помощью **/cmd/next-phase/{chain_id}** или установить конкретную фазу через **/cmd/set-phase/{chain_id}**. 
Статус, последний шаг и иную информацию цепочки можно получить с помощью **/cmd/chain-phase/{chain_id}**.
> Обратите внимание, что если, например, вы загрузили полезную нагрузку через команду curl, используя UUID полезной нагрузки Mythic, она останется старой полезной нагрузкой во время воспроизведения, потому что шаг атаки типа agent / local уже сохранил оригинальную полезную нагрузку. Это сделано для простоты и является одним из примеров того, почему стабильность нашего проекта зависит от стабильности Mythic; вам все равно нужно использовать Mythic в какой-то степени. *Профили* для полезных нагрузок агентов также создаются перед запуском EAGLE.

Чтобы запустить цепочку, используйте **/cmd/run-chain/{chain_id}**, который передает вывод каждого шага в виде HTTP-чанков. 
Аварийная остановка практически доступна через WebSocket или HTTP-эндпоинты отмены либо через GUI. 
Для удобства и стабильности минимальный интерфейс предоставляется по адресу **/f/index**, предлагая выполнение команд (агент / локально), анализ вывода с помощью LLM и управление цепочками.


### /llm/ , основная задача ллмки

Вы можете генерировать payload и скрипты через LLM, автоматически анализировать вывод через LLM, почти как *пентест с LLM*. 
В настоящее время, если команда не выполняется, она не будет сохранена в базе данных, но интеграция LLM со временем станет более интуитивной.

Вы можете кратко описать задачу и сгенерировать команду EAGLE через `LLM`, отправив POST-запрос на **/llm/suggest-action**, затем при необходимости исправить и исполнить ее, применив POST-запрос на **/cmd/approve-action**, указав некоторые служебные данные, такие как agent_id (то же, что и display id). При создании предположения `AI` учитывает текущую фазу килчейна, значения самых последних команд/шагов (такие как статус и вывод), текущую цепочку и затем пытается предложить потенциально эффективные векторы атаки и команды, целевую ОС и некоторую служебную информацию.

### /export-chain/

Экспортируйте цепочку (с анализом LLM или без него) через **/export-chain/json** или **/export-chain/yaml** в `JSON` или `YAML`.

---
Аналогично тому, как изучение исходного кода [библиотеки Mythic python](https://github.com/MythicMeta/Mythic_Scripting/blob/master/mythic/mythic.py) проясняет ее функциональность, изучение других ручек Swagger и чтение кода `EAGLE` предоставляет более глубокое понимание его эффективного использования. Если что-то непонятно, напишите об этом в разделе [issues](https://github.com/eogod/EAGLE/issues).

